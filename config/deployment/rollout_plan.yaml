#
# Production Rollout Plan
#
# Defines the strategy for rolling out the new NLP architecture to production.
#

# Rollout metadata
rollout:
  name: "NLP Architecture v2.0"
  version: "2.0.0"
  description: "Transformation from superficial label-renaming to true domain-specific NLP"
  owner: "nlp-team"
  start_date: "2025-01-15"

# Rollout strategy
strategy:
  type: "canary"  # Options: canary, blue_green, percentage, ring
  validation_wait_minutes: 5
  auto_advance: false  # Require manual approval between stages

# Canary stages (percentage milestones)
canary_stages:
  - percentage: 1
    description: "Internal testing"
    duration_hours: 24
    success_criteria:
      - metric: "error_rate"
        threshold: 0.05
        comparison: "less_than"
      - metric: "p95_latency_ms"
        threshold: 500
        comparison: "less_than"
    auto_rollback: true

  - percentage: 5
    description: "Early adopters"
    duration_hours: 48
    success_criteria:
      - metric: "error_rate"
        threshold: 0.03
        comparison: "less_than"
      - metric: "accuracy"
        threshold: 0.90
        comparison: "greater_than"
    auto_rollback: true

  - percentage: 10
    description: "Beta users"
    duration_hours: 72
    success_criteria:
      - metric: "error_rate"
        threshold: 0.02
        comparison: "less_than"
      - metric: "user_satisfaction"
        threshold: 4.0
        comparison: "greater_than"
    auto_rollback: true

  - percentage: 25
    description: "Quarter rollout"
    duration_hours: 168  # 1 week
    success_criteria:
      - metric: "error_rate"
        threshold: 0.02
        comparison: "less_than"
      - metric: "throughput_degradation"
        threshold: 0.10
        comparison: "less_than"
    auto_rollback: false  # Manual decision

  - percentage: 50
    description: "Half rollout"
    duration_hours: 336  # 2 weeks
    success_criteria:
      - metric: "error_rate"
        threshold: 0.01
        comparison: "less_than"
    auto_rollback: false

  - percentage: 100
    description: "Full rollout"
    duration_hours: -1  # Permanent
    success_criteria: []
    auto_rollback: false

# Feature flags to enable
feature_flags:
  - name: "dynamic_ner_models"
    enabled: true
    rollout_percentage: 0  # Controlled by canary stages

  - name: "kb_enrichment"
    enabled: true
    rollout_percentage: 0

  - name: "pattern_matching"
    enabled: true
    rollout_percentage: 0

  - name: "pipeline_orchestration"
    enabled: true
    rollout_percentage: 0

  - name: "hot_swapping"
    enabled: true
    rollout_percentage: 0

  - name: "self_optimization"
    enabled: false  # Enable after initial rollout

# Component versions
components:
  - name: "ner_models"
    current_version: "1.0.0"
    target_version: "2.0.0"
    rollback_version: "1.0.0"

  - name: "knowledge_bases"
    current_version: "1.0.0"
    target_version: "2.0.0"
    rollback_version: "1.0.0"

  - name: "pattern_matching"
    current_version: "none"
    target_version: "2.0.0"
    rollback_version: "none"

  - name: "pipeline"
    current_version: "1.0.0"
    target_version: "2.0.0"
    rollback_version: "1.0.0"

# Monitoring
monitoring:
  enabled: true
  alert_channels:
    - "email: nlp-team@example.com"
    - "slack: #nlp-alerts"

  critical_metrics:
    - "error_rate"
    - "p95_latency_ms"
    - "accuracy"
    - "throughput"

  dashboards:
    - "Grafana: NLP Pipeline Monitoring"
    - "Prometheus: /metrics"

# Rollback procedures
rollback:
  strategy: "immediate"  # Options: immediate, gradual, targeted

  triggers:
    - condition: "error_rate > 0.10"
      action: "immediate_rollback"

    - condition: "p95_latency_ms > 2000"
      action: "alert_and_pause"

    - condition: "accuracy < 0.75"
      action: "immediate_rollback"

  contact:
    primary: "on-call-engineer"
    secondary: "nlp-team-lead"

# A/B testing
ab_tests:
  - test_id: "biobert_vs_pubmedbert"
    description: "Compare BioBERT and PubMedBERT performance"
    control: "biobert"
    treatment: "pubmedbert"
    traffic_split: 0.5
    duration_days: 7
    metrics:
      - "latency"
      - "accuracy"
      - "entity_count"

  - test_id: "umls_vs_rxnorm_priority"
    description: "Test KB priority order"
    control: "umls_first"
    treatment: "rxnorm_first"
    traffic_split: 0.5
    duration_days: 7
    metrics:
      - "kb_lookup_duration"
      - "cache_hit_rate"
      - "accuracy"

# Communication plan
communication:
  pre_rollout:
    - "Send announcement to stakeholders"
    - "Update status page"
    - "Schedule team on-call"

  during_rollout:
    - "Send updates at each stage"
    - "Monitor dashboard continuously"
    - "Respond to alerts within 5 minutes"

  post_rollout:
    - "Send completion report"
    - "Collect feedback"
    - "Document lessons learned"

# Success criteria
success_criteria:
  overall:
    - "Error rate < 1%"
    - "P95 latency < 300ms"
    - "Accuracy improvement > 5%"
    - "Zero critical incidents"
    - "Positive user feedback"

  business:
    - "Entity extraction improved"
    - "Knowledge base enrichment working"
    - "Pattern matching accurate"
    - "Cost neutral or reduced"
