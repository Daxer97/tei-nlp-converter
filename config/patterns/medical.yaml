#
# Medical Pattern Matching Configuration
#
# This file configures pattern matching for medical domain structured data
# including ICD codes, CPT codes, dosages, routes, and other medical entities.
#

# Pattern type configuration
patterns:
  icd_code:
    enabled: true
    description: "ICD-10 diagnosis codes"
    validation:
      enabled: true
      strict: true  # Reject invalid codes
    normalization:
      enabled: true
      format: "uppercase"  # I10 vs i10
      add_decimal: true    # I10 -> I10.0
    examples:
      - "I10"      # Essential hypertension
      - "E11.9"    # Type 2 diabetes
      - "J44.1"    # COPD with exacerbation

  cpt_code:
    enabled: true
    description: "CPT procedure codes"
    validation:
      enabled: true
      check_ranges: true
    normalization:
      enabled: false
    examples:
      - "99213"    # Office visit
      - "80053"    # Comprehensive metabolic panel
      - "93000"    # EKG

  dosage:
    enabled: true
    description: "Medication dosages"
    validation:
      enabled: false
      check_reasonable_ranges: true  # Warn on extreme doses
    normalization:
      enabled: true
      standardize_units: true  # Convert to standard units
      decimal_places: 2
    examples:
      - "500 mg"
      - "2.5 ml"
      - "100 mcg"
      - "1000 units"

  route:
    enabled: true
    description: "Routes of administration"
    validation:
      enabled: true
    normalization:
      enabled: true
      use_abbreviations: true  # "intravenous" -> "IV"
    examples:
      - "IV"
      - "PO"
      - "IM"
      - "SC"

  frequency:
    enabled: true
    description: "Medication frequency"
    validation:
      enabled: true
    normalization:
      enabled: true
      use_abbreviations: true
    examples:
      - "BID"      # Twice daily
      - "TID"      # Three times daily
      - "Q4H"      # Every 4 hours
      - "PRN"      # As needed

  lab_measurement:
    enabled: true
    description: "Laboratory measurements"
    validation:
      enabled: false
    normalization:
      enabled: true
      standardize_units: true
    examples:
      - "120/80 mmHg"
      - "7.2 mg/dL"
      - "98.6°F"

# Context rules for disambiguation
# These adjust confidence based on surrounding text
context_rules:
  - pattern_type: "ICD_CODE"
    before_keywords:
      - "diagnosis"
      - "diagnosed with"
      - "ICD"
      - "ICD-10"
      - "code"
      - "condition"
    after_keywords:
      - "diagnosis"
      - "condition"
    confidence_boost: 0.15

  - pattern_type: "CPT_CODE"
    before_keywords:
      - "procedure"
      - "CPT"
      - "code"
      - "billed"
      - "performed"
    after_keywords:
      - "procedure"
      - "service"
    confidence_boost: 0.15

  - pattern_type: "DOSAGE"
    before_keywords:
      - "prescribed"
      - "administered"
      - "dose"
      - "dosage"
      - "given"
      - "ordered"
    after_keywords:
      - "daily"
      - "twice"
      - "every"
      - "per"
    confidence_boost: 0.1

  - pattern_type: "ROUTE"
    before_keywords:
      - "administered"
      - "given"
      - "via"
      - "route"
    after_keywords:
      - "administration"
      - "route"
    confidence_boost: 0.1

  - pattern_type: "FREQUENCY"
    before_keywords:
      - "take"
      - "administer"
      - "give"
    after_keywords:
      - "daily"
      - "day"
      - "hours"
    confidence_boost: 0.1

# Validation configuration
validation:
  # ICD-10 specific validation
  icd_code:
    check_chapter: true      # Verify first letter is valid chapter
    check_structure: true    # Verify format matches ICD-10 structure
    allow_incomplete: false  # Allow codes without subcategories (e.g., "I10" vs "I10.0")

  # CPT specific validation
  cpt_code:
    check_category_ranges: true  # Verify code is in valid CPT range
    warn_on_deleted: true        # Warn if code is known to be deleted

  # Dosage specific validation
  dosage:
    warn_thresholds:
      mg:
        min: 0.001
        max: 10000
      ml:
        min: 0.1
        max: 1000
      units:
        min: 1
        max: 100000

# Normalization configuration
normalization:
  # Dosage unit conversions
  dosage_units:
    # Convert micrograms to standard form
    "µg": "mcg"
    "ug": "mcg"
    "μg": "mcg"
    # Convert liters
    "L": "ml"
    "liter": "ml"
    "liters": "ml"

  # Route abbreviations
  routes:
    "intravenous": "IV"
    "intravenously": "IV"
    "intramuscular": "IM"
    "intramuscularly": "IM"
    "oral": "PO"
    "orally": "PO"
    "by mouth": "PO"
    "subcutaneous": "SC"
    "subcutaneously": "SC"
    "sublingual": "SL"
    "sublingually": "SL"
    "topical": "TOP"
    "topically": "TOP"
    "inhalation": "INH"
    "inhaled": "INH"
    "rectal": "PR"
    "rectally": "PR"

  # Frequency abbreviations
  frequencies:
    "once daily": "QD"
    "once a day": "QD"
    "twice daily": "BID"
    "twice a day": "BID"
    "three times daily": "TID"
    "three times a day": "TID"
    "four times daily": "QID"
    "four times a day": "QID"
    "as needed": "PRN"
    "when needed": "PRN"
    "every 4 hours": "Q4H"
    "every 6 hours": "Q6H"
    "every 8 hours": "Q8H"
    "every 12 hours": "Q12H"
    "at bedtime": "HS"
    "before meals": "AC"
    "after meals": "PC"

# Priority configuration
# Higher priority patterns are preferred when overlaps occur
priority:
  icd_code: 10
  cpt_code: 10
  dosage: 8
  route: 7
  frequency: 7
  lab_measurement: 6

# Performance tuning
performance:
  # Maximum context window for checking surrounding text
  max_context_window: 100  # characters

  # Enable caching of regex compilation
  cache_compiled_patterns: true

  # Batch processing configuration
  batch_size: 1000  # Process text in chunks for very large documents
