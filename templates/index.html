<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="TEI NLP Converter - Process natural language text with NLP and convert to TEI XML">
    
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    
    <title>TEI NLP Converter v{{ version }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <header>
            <h1>TEI NLP Converter</h1>
            <p>Process natural language text and convert to TEI XML</p>
            <div class="version">v{{ version }}</div>
        </header>
        
        <main>
            <!-- Status Messages -->
            <div id="status-message" class="status-message" style="display: none;">
                <span class="status-text"></span>
                <button class="close-btn" onclick="closeStatus()">×</button>
            </div>
            
            <!-- Input Section -->
            <section class="input-section card">
                <h2>Input Text</h2>
                
                <form id="process-form" method="post" action="/process">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    
                    <div class="form-group">
                        <label for="processing-mode">Processing Mode:</label>
                        <select id="processing-mode" name="processing_mode" class="form-control" aria-label="Select processing mode">
                            <option value="general">General NLP</option>
                            <option value="classical">Classical Languages (Latin/Greek)</option>
                        </select>
                        <small class="help-text">Choose processing mode based on text type</small>
                    </div>

                    <!-- General Processing Options -->
                    <div id="general-options">
                        <div class="form-group">
                            <label for="domain">Ontological Domain:</label>
                            <select id="domain" name="domain" class="form-control" aria-label="Select ontological domain">
                                {% for domain in domains %}
                                <option value="{{ domain }}">{{ domain|title }}</option>
                                {% endfor %}
                            </select>
                            <small class="help-text">Choose the domain for specialized TEI schema</small>
                        </div>
                    </div>

                    <!-- Classical Language Options -->
                    <div id="classical-options" style="display: none;">
                        <div class="form-group">
                            <label for="classical-language">Language:</label>
                            <select id="classical-language" name="classical_language" class="form-control" aria-label="Select classical language">
                                <option value="auto">Auto-detect (recommended)</option>
                                <option value="latin">Latino</option>
                                <option value="ancient_greek">Greco Antico</option>
                            </select>
                            <small class="help-text">Automatic detection works well for most texts</small>
                        </div>

                        <div class="form-group">
                            <label for="classical-model">NLP Model:</label>
                            <select id="classical-model" name="classical_model" class="form-control" aria-label="Select NLP model">
                                <option value="">Auto (based on language)</option>
                                <optgroup label="Latino">
                                    <option value="latincy">LatinCy (spaCy-based)</option>
                                    <option value="cltk-latin">CLTK Latin</option>
                                </optgroup>
                                <optgroup label="Greco Antico">
                                    <option value="cltk-greek">CLTK Greek</option>
                                </optgroup>
                            </select>
                            <small class="help-text">Each model has different strengths</small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-botanical" name="include_botanical" checked>
                                Include botanical term annotations (Progetto Virgilio)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="text-input">Enter Text:</label>
                        <textarea 
                            id="text-input" 
                            name="text"
                            class="form-control" 
                            rows="10" 
                            maxlength="100000"
                            placeholder="Enter or paste your text here (max 100,000 characters)..."
                            aria-label="Input text for processing"></textarea>
                        <div class="char-count">
                            <span id="char-count">0</span> / 100,000 characters
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-input">Or Upload File:</label>
                        <div class="file-input-wrapper">
                            <input 
                                type="file" 
                                id="file-input" 
                                accept=".txt,.text,.md,.markdown" 
                                class="form-control"
                                aria-label="Upload text file">
                            <small class="help-text">Supported: .txt, .md (max 100KB)</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Processing Options:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-dependencies" name="include_dependencies" checked>
                                Include dependencies
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-pos" name="include_pos" checked>
                                Include POS tags
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-lemma" name="include_lemma" checked>
                                Include lemmas
                            </label>
                        </div>
                    </div>
                    
                    <button id="process-btn" type="submit" class="btn btn-primary" aria-label="Process text">
                        <span class="btn-text">Process Text</span>
                        <span class="loading-spinner" style="display: none;"></span>
                    </button>
                </form>
            </section>
            
            <!-- Results Section -->
            <section class="results-section card" id="results" style="display: none;">
                <h2>Processing Results</h2>
                
                <div class="processing-info">
                    <span id="processing-time"></span>
                    <span id="task-status"></span>
                </div>
                
                <div class="tabs" role="tablist">
                    <button class="tab-btn active" data-tab="nlp" role="tab" aria-selected="true">
                        NLP Results
                    </button>
                    <button class="tab-btn" data-tab="tei" role="tab" aria-selected="false">
                        TEI XML
                    </button>
                    <button class="tab-btn" data-tab="visual" role="tab" aria-selected="false">
                        Visualization
                    </button>
                    <button class="tab-btn" data-tab="stats" role="tab" aria-selected="false">
                        Statistics
                    </button>
                </div>
                
                <div class="tab-content">
                    <div id="nlp-tab" class="tab-pane active" role="tabpanel">
                        <h3>NLP Analysis</h3>
                        <div id="nlp-results" class="results-container"></div>
                    </div>
                    
                    <div id="tei-tab" class="tab-pane" role="tabpanel">
                        <h3>TEI XML Output</h3>
                        <div class="toolbar">
                            <button id="copy-xml-btn" class="btn btn-sm">Copy XML</button>
                            <button id="download-btn" class="btn btn-sm btn-secondary">Download TEI XML</button>
                        </div>
                        <pre id="tei-xml" class="xml-output"></pre>
                    </div>
                    
                    <div id="visual-tab" class="tab-pane" role="tabpanel">
                        <h3>TEI Structure Visualization</h3>
                        <div id="tei-visual" class="tree-view"></div>
                    </div>
                    
                    <div id="stats-tab" class="tab-pane" role="tabpanel">
                        <h3>Processing Statistics</h3>
                        <div id="stats-content" class="stats-grid"></div>
                    </div>
                </div>
            </section>
            
            <!-- Occurrence Search Section (Classical texts) -->
            <section class="search-section card" id="occurrence-search" style="display: none;">
                <h2>Ricerca Occorrenze</h2>

                <form id="search-form">
                    <div class="form-group">
                        <label for="search-query">Parola da cercare:</label>
                        <input type="text" id="search-query" class="form-control"
                               placeholder="es. vitis, agricola, ager..." maxlength="200">
                    </div>

                    <div class="form-group">
                        <label>Modalita di ricerca:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="search-mode" value="exact" checked>
                                Esatta (trova solo la forma esatta)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="search-mode" value="lemmatized">
                                Lemmatizzata (trova tutte le forme flesse)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="search-mode" value="regex">
                                Regex (espressione regolare)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="search-mode" value="fuzzy">
                                Fuzzy (varianti ortografiche)
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label for="words-before">Parole prima:</label>
                            <select id="words-before" class="form-control">
                                <option value="3">3</option>
                                <option value="5" selected>5</option>
                                <option value="7">7</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label for="words-after">Parole dopo:</label>
                            <select id="words-after" class="form-control">
                                <option value="3">3</option>
                                <option value="5" selected>5</option>
                                <option value="7">7</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="fuzzy-options" style="display: none;">
                        <label for="fuzzy-threshold">Soglia similarita (fuzzy):</label>
                        <input type="range" id="fuzzy-threshold" min="50" max="100" value="80" class="form-control">
                        <span id="fuzzy-value">80%</span>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        Cerca Occorrenze
                    </button>
                </form>

                <!-- Search Results -->
                <div id="search-results" style="display: none;">
                    <div class="search-stats">
                        <span id="search-total">0 occorrenze trovate</span>
                        <span id="search-frequency"></span>
                    </div>

                    <div class="search-actions">
                        <button id="export-html-btn" class="btn btn-sm btn-secondary">
                            Scarica Report HTML
                        </button>
                    </div>

                    <div id="search-list" class="search-list"></div>

                    <div id="search-wordcloud" class="wordcloud-section">
                        <h3>Parole Circostanti</h3>
                        <div class="wordcloud"></div>
                    </div>
                </div>
            </section>

            <!-- Botanical Terms Section -->
            <section class="botanical-section card" id="botanical-results" style="display: none;">
                <h2>Termini Botanici Identificati</h2>
                <div id="botanical-list" class="botanical-list"></div>
            </section>

            <!-- History Section -->
            <section class="history-section card">
                <h2>Processing History</h2>
                <div class="history-controls">
                    <button id="refresh-history-btn" class="btn btn-sm">Refresh</button>
                    <select id="history-filter" class="form-control-sm">
                        <option value="">All domains</option>
                        {% for domain in domains %}
                        <option value="{{ domain }}">{{ domain|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="history-list" class="history-list"></div>
                <div id="history-pagination" class="pagination"></div>
            </section>
        </main>
        
        <footer>
            <p>TEI NLP Converter © 2024 | <a href="/api/docs" target="_blank">API Documentation</a></p>
        </footer>
    </div>
    
    <!-- Task Progress Modal -->
    <div id="task-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Processing Large Text</h3>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p id="task-message">Processing your text in the background...</p>
            <button id="cancel-task-btn" class="btn btn-sm">Cancel</button>
        </div>
    </div>
    
    <script src="/static/script.js?v=7"></script>
</body>
</html>
